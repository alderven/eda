<?phpsession_start();if(!isset($_SESSION['myusername'])) {header("location:index.php");}require_once "config.php";require_once "common.php";# 1. Check for Admin privelegesis_admin($role_id);# 2. Get ExcelId$excel_id = isset($_POST['ExcelId']) ? $_POST['ExcelId'] : '';if ($excel_id == '') {	alert("danger", "Excel файл не найден", "excel.php");}# 3. Check that anybody makes an order in Excel# error_log('Ordered Dishes Count: "' . ordered_dishes_count($conn, $excel_id) . '". Excel Id: "' . $excel_id . '"', 0);if (ordered_dishes_count($conn, $excel_id) == 0) {	alert("danger", "Заказчики отсутствуют", "excel.php");}# 4. Make Excel file copy$file_location = Null;$sql = "SELECT FileLocation FROM excel WHERE Id = $excel_id";$result = $conn->query($sql);while ($row = $result->fetch_assoc()) {	$file_location  = $row["FileLocation"];}$file_location_win_encoding = mb_convert_encoding($file_location, "Windows-1251");		$path_parts = pathinfo($file_location);$newfile = $path_parts['dirname'] . DIRECTORY_SEPARATOR . 'Menu_Aggregated_' . date('YmdHis') . '.xls';	if (!copy($file_location_win_encoding, $newfile)) {	alert("danger", "Ошибка копирования из файла $file_location_win_encoding в файл $newfile", "excel.php");}# 5. Call Python and update Excel file$attempts = 10;$output = Null;$exit_code = Null;for ($i = 1; $i <= $attempts; $i++) {	error_log('Attempt ' . $i . ' to execute Python script for Excel file: ' . $newfile , 0);	$exit_code = exec("\"C:/Program Files/Python36/python.exe\" ../cgi-bin/ParseAndAggregate.cgi aggregate all $excel_id \"" . $newfile . "\"", $output, $exit_code);	if ($exit_code == 'OK') {		break;	}}if ($exit_code != 'OK') {	alert("danger", "Ошибка при выполнении Python скрипта", "excel.php");}# 6. Send file to downloadheader('Content-Description: File Transfer');header('Content-Type: application/octet-stream');header('Content-Disposition: attachment; filename="'.basename($newfile).'"');header('Expires: 0');header('Cache-Control: must-revalidate');header('Pragma: public');header('Content-Length: ' . filesize($newfile));readfile($newfile);?>