<?phptry_again:# 1. Get Excel File Path and Name$file = isset($_GET['optradio']) ? $_GET['optradio'] : '';# 2. Check if File Existif (empty($file)){ 	print 'Отсутствуют меню для скачивания и/или меню еще никем не заполнено.';}else {		# 3. Set correct DB encoding	require_once "config.php";	$sql = "SET NAMES utf8";	$conn->query($sql);		# 4. Get data for Ludmila	$dates = array();	$dates_only = array();	$full_name = array();	$dishes = array();	$sql = "SELECT $table_food.Company, $table_food.Date, $table_users.Name, $table_users.Surname, $table_food.Name as FoodName, $table_food.Contain			FROM $table_users				JOIN $table_orders					ON $table_orders.UserId = $table_users.Id				JOIN $table_food					ON $table_food.Id = $table_orders.MenuItemId			WHERE $table_food.ExcelId = '$file' ORDER BY $table_food.Date ASC, $table_users.Name ASC";	$result = $conn->query($sql);		# 5. Download Excel file in case nobody filling it	if ($result->num_rows === 0)	{			# 5.1 Get the dates range		$sql = "SELECT DISTINCT Date FROM $table_food WHERE ExcelId = '$file' ORDER BY Date ASC";		$result = $conn->query($sql);		while ($row = $result->fetch_assoc()) {			array_push($dates, $row["Date"]);		}				# 5.2 Get the Company Name		$sql = "SELECT DISTINCT Company FROM $table_food WHERE ExcelId = '$file'";		$result = $conn->query($sql);		$company = '';		while ($row = $result->fetch_assoc()) {			$company =  $row["Company"];		}				$newfile = './upload/' . $company . '_Пустое_меню_' . $dates[0] . '_' . $dates[count($dates)-1] . '.xls';		if (!copy($file, $newfile)) {				echo "Ошибка копирования файла $file...\n";		}		else if (file_exists($newfile)) {						//print 'Download Empty File';			header('Content-Description: File Transfer');			header('Content-Type: application/octet-stream');			header('Content-Disposition: attachment; filename="'.basename($newfile).'"');			header('Expires: 0');			header('Cache-Control: must-revalidate');			header('Pragma: public');			header('Content-Length: ' . filesize($newfile));			readfile($newfile);			exit;		}	}	# 6. Download Excel file in case somebody filling it	else	{		# 6.1 Get the days of the week		while ($row = $result->fetch_assoc()) {						$dayofweek = date('w', strtotime($row["Date"]));			if($dayofweek == 1) {				$dayofweek = 'Понедельник';			} elseif($dayofweek == 2) {				$dayofweek = 'Вторник';			} elseif($dayofweek == 3) {				$dayofweek = 'Среда';			} elseif($dayofweek == 4) {				$dayofweek = 'Четверг';			} elseif($dayofweek == 5) {				$dayofweek = 'Пятница';			} elseif($dayofweek == 6) {				$dayofweek = 'Суббота';			} elseif($dayofweek == 7) {				$dayofweek = 'Воскресенье';			} else {				$dayofweek = '';			};						$company = $row["Company"];			array_push($dates, $dayofweek . ', ' . $row["Date"]);			array_push($dates_only, $row["Date"]);			array_push($full_name, $row["Name"] . ' ' . $row["Surname"]);			array_push($dishes, $row["FoodName"] . ' ' . $row["Contain"]);		}		# 6.2 Call Python script and fill Excel file with orders		$newfile = '/upload/' . $company . '_Суммарное_меню_' . $dates_only[0] . '_' . $dates_only[count($dates_only)-1] . '.xls';		if (!copy('./upload/' . basename($file).PHP_EOL, $newfile)) {				echo "Ошибка копирования файла '$file' в '$newfile'\n";			}		else {			exec("C:/Python34/python ../cgi-bin/ParseAndAggregate.cgi aggregate all \"" . $file . "\"" . $newfile . "\"");						if (file_exists($newfile)) {				header('Content-Description: File Transfer');				header('Content-Type: application/octet-stream');				header('Content-Disposition: attachment; filename="'.basename($newfile).'"');				header('Expires: 0');				header('Cache-Control: must-revalidate');				header('Pragma: public');				header('Content-Length: ' . filesize($newfile));				readfile($newfile);				exit;			}			else {			print 'Файл не найден.';			goto try_again;			//print 'Не удалось сгенерировать Excel файл. Попробуйте еще раз.';			}						}	}			}require_once "footer.php";?>