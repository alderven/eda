<?phprequire_once "config.php";try_again:// 1. Get ExcelId$file = isset($_POST['optradio']) ? $_POST['optradio'] : '';# 2. Check if File Existif (empty($file)){ 	print 'Запрашиваемый файл не найден';}else {			# 4. Check if anybody make an order in Excel	$sql = "SELECT $table_food.Company, $table_food.Date, $table_users.Name, $table_users.Surname, $table_food.Name as FoodName, $table_food.Contain			FROM $table_users				JOIN $table_orders					ON $table_orders.UserId = $table_users.Id				JOIN $table_food					ON $table_food.Id = $table_orders.MenuItemId			WHERE $table_food.ExcelId = '$file' ORDER BY $table_food.Date ASC, $table_users.Name ASC";		if ($result = $conn->query($sql)) {				# 5. Make Excel file copy		$file_win_encoding = mb_convert_encoding($file, "Windows-1251");				$path_parts = pathinfo($file);		$newfile = $path_parts['dirname'] . DIRECTORY_SEPARATOR . "MENU_BCE.xls";				if (!copy($file_win_encoding, $newfile)) {			print "Ошибка копирования из файла $file_win_encoding в файл $newfile";		}		else if (file_exists($newfile)) {						# 6. Call Python to generate Excel file			exec("C:/Python34/python ../cgi-bin/ParseAndAggregate.cgi aggregate all \"" . $file . "\" \"" . $newfile . "\"");						if (file_exists($newfile)) {				header('Content-Description: File Transfer');				header('Content-Type: application/octet-stream');				header('Content-Disposition: attachment; filename="'.basename($newfile).'"');				header('Expires: 0');				header('Cache-Control: must-revalidate');				header('Pragma: public');				header('Content-Length: ' . filesize($newfile));				readfile($newfile);				exit;			}			else {				print "Файл не найден после операции агрегирования.";			}		}		else {			print "Файл не найден: $newfile";		}	}	else {		print 'Еще никто не делал заказ';	}}require_once "footer.php";?>